<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aera 4B RAG Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #a855f7;
            --secondary-dark: #9333ea;
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-light: #9ca3af;
            --border: #e5e7eb;
            --success: #10b981;
            --success-dark: #059669;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: #f3f4f6;
            background-image: 
                radial-gradient(circle at 25px 25px, rgba(99, 102, 241, 0.15) 2%, transparent 0%),
                radial-gradient(circle at 75px 75px, rgba(99, 102, 241, 0.1) 2%, transparent 0%);
            background-size: 100px 100px;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
        }

        .header h1 {
            font-weight: 800;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(229, 231, 235, 0.5);
        }

        .card-header {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
        }

        .card-header-icon {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        input[type="url"],
        input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            outline: none;
        }

        input[type="url"]:focus,
        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .button {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.1);
        }

        .button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-success {
            background: var(--success);
        }

        .button-success:hover {
            background: var(--success-dark);
        }

        .button-icon {
            margin-right: 0.5rem;
        }

        .progress-container {
            margin-top: 1.5rem;
            display: none;
        }

        .progress-container h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #f3f4f6;
            border-radius: 6px;
            overflow: hidden;
            height: 10px;
            margin-bottom: 0.75rem;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: width 0.3s ease-in-out;
            border-radius: 6px;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        #chat-output {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 8px;
            background: #f9fafb;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .message {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            margin-left: auto;
            background: var(--primary);
            color: white;
            border-radius: 12px 12px 0 12px;
        }

        .bot-message {
            margin-right: auto;
            background: white;
            color: var(--text-primary);
            border-radius: 12px 12px 12px 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .bot-message a {
            color: var(--primary);
            text-decoration: none;
            word-break: break-all;
        }

        .bot-message a:hover {
            text-decoration: underline;
        }

        .chat-input-container {
            display: flex;
            gap: 0.75rem;
        }

        .chat-input-container input {
            flex: 1;
        }

        .chat-status {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
            background: var(--text-light);
        }

        .status-connected .status-icon {
            background: var(--success);
        }

        .status-error .status-icon {
            background: var(--error);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card-header {
                padding: 1rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* Subtle animations */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        /* Typing animation */
        .typing-indicator {
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 12px;
            display: none; /* Hidden by default */
            align-items: center;
            width: fit-content;
            margin-bottom: 1rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 1px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0% {
                transform: translateY(0px);
                background-color: #9ca3af;
            }
            50% {
                transform: translateY(-5px);
                background-color: #6366f1;
            }
            100% {
                transform: translateY(0px);
                background-color: #9ca3af;
            }
        }
        
        /* Branding badges and footer */
        .badges {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }
        .badge {
            background: rgba(168, 85, 247, 0.12);
            color: #6b21a8;
            border: 1px solid rgba(168, 85, 247, 0.35);
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 2rem 0 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Aera 4B — RAG Demo</h1>
            <p>Open-source 4B model demo. Crawl websites, build a local RAG index, and chat with Aera 4B.</p>
            <div class="badges">
                <span class="badge">Aera 4B</span>
                <span class="badge">Open Source</span>
                <span class="badge">Local RAG</span>
            </div>
        </div>

        <div id="project-load-section" class="card">
            <div class="card-header">
                <div class="card-header-icon" style="background: var(--secondary);">
                    <i class="fas fa-folder-open"></i>
                </div>
                <h2>Load Existing Project</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="project-select">Select Project</label>
                    <select id="project-select" name="project-select" class="input" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background-color: white;">
                        <option value="">Loading projects...</option>
                    </select>
                </div>
                <button id="load-project-btn" class="button button-success" disabled>
                    <i class="fas fa-upload button-icon"></i>Load Selected Project
                </button>
                <div id="project-load-status" class="progress-text" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <div id="crawl-section" class="card">
            <div class="card-header">
                <div class="card-header-icon">
                    <i class="fas fa-spider"></i>
                </div>
                <h2>Crawl & Index (Build RAG)</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="url">Enter Starting URL</label>
                    <input type="url" id="url" name="url" required placeholder="https://example.com">
                </div>
                <button id="start-crawl-btn" class="button">
                    <i class="fas fa-play button-icon"></i>Start Crawling
                </button>

                <div id="progress-container" class="progress-container">
                    <h3><i class="fas fa-sync-alt fa-spin" style="margin-right: 0.5rem;"></i>Progress</h3>
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <div id="progress-text" class="progress-text">Initializing...</div>
                </div>
                <button id="start-chat-btn" class="button button-success" style="display: none; margin-top: 1.5rem;">
                    <i class="fas fa-comments button-icon"></i>Start Chatting
                </button>
            </div>
        </div>

        <div id="chat-section" class="card" style="display: none;">
            <div class="card-header">
                <div class="card-header-icon" style="background: var(--secondary);">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <h2>Chat with Aera 4B (RAG)</h2>
            </div>
            <div class="card-body">
                <div id="chat-output">
                    <div class="typing-indicator" id="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Ask Aera 4B about the crawled content...">
                    <button id="send-chat-btn" class="button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div id="chat-status" class="chat-status">
                    <div class="status-icon"></div>
                    <span>Connecting...</span>
                </div>
            </div>
        </div>
        <div class="footer">Powered by Aera 4B — an open‑source 4B parameter model. This UI is a local RAG demo for quick testing.</div>
    </div>

    <script>
        let socket = null;
        let crawlEventSource = null;

        const crawlSection = document.getElementById('crawl-section');
        const chatSection = document.getElementById('chat-section');
        const startCrawlBtn = document.getElementById('start-crawl-btn');
        const urlInput = document.getElementById('url');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const startChatBtn = document.getElementById('start-chat-btn');
        const chatOutput = document.getElementById('chat-output');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatStatus = document.getElementById('chat-status');
        const typingIndicator = document.getElementById('typing-indicator');
        let currentBotMessage = null;
        let currentBotContent = '';

        // New elements for project loading
        const projectLoadSection = document.getElementById('project-load-section');
        const projectSelect = document.getElementById('project-select');
        const loadProjectBtn = document.getElementById('load-project-btn');
        const projectLoadStatus = document.getElementById('project-load-status');

        function updateProgress(percent, text, statusType = "progress") {
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressText.textContent = text;

            progressBar.classList.remove('progress-bar-error', 'progress-bar-success');
            if (statusType === "error") {
                progressBar.classList.add('progress-bar-error'); // You'll need to define this style
            } else if (statusType === "completed") {
                 progressBar.classList.add('progress-bar-success'); // And this one
            }
        }

        async function loadProjectsList() {
            projectSelect.innerHTML = '<option value=\"\">Loading projects...</option>';
            loadProjectBtn.disabled = true;
            try {
                const response = await fetch('/list-projects');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const projects = await response.json();
                projectSelect.innerHTML = ''; // Clear loading message
                if (projects.length > 0) {
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project;
                        option.textContent = project.charAt(0).toUpperCase() + project.slice(1); // Capitalize
                        projectSelect.appendChild(option);
                    });
                    loadProjectBtn.disabled = false;
                    projectLoadStatus.textContent = "Select a project to load.";
                } else {
                    projectSelect.innerHTML = '<option value=\"\">No saved projects found.</option>';
                    projectLoadStatus.textContent = "No saved projects. Crawl a new website to create one.";
                }
            } catch (error) {
                console.error('Error fetching projects:', error);
                projectSelect.innerHTML = '<option value=\"\">Error loading projects.</option>';
                projectLoadStatus.textContent = `Failed to load projects: ${error.message}`;
            }
        }

        async function loadSelectedProject() {
            const selectedProject = projectSelect.value;
            if (!selectedProject) {
                projectLoadStatus.textContent = "Please select a project.";
                return;
            }

            loadProjectBtn.disabled = true;
            loadProjectBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin button-icon"></i>Loading Project...';
            projectLoadStatus.textContent = `Loading project '${selectedProject}'...`;
            startCrawlBtn.disabled = true; // Disable crawl button during project load
            urlInput.disabled = true;


            try {
                const response = await fetch(`/load-project/${selectedProject}`, { method: 'POST' });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || `Failed to load project '${selectedProject}'.`);
                }

                projectLoadStatus.textContent = `Project '${selectedProject}' loaded successfully! Transitioning to chat...`;
                // Give a moment for the user to see the message, then transition
                setTimeout(() => {
                    transitionToChat(selectedProject);
                }, 1500);

            } catch (error) {
                console.error('Error loading project:', error);
                projectLoadStatus.textContent = `Error: ${error.message}`;
                loadProjectBtn.disabled = false;
                loadProjectBtn.innerHTML = '<i class="fas fa-upload button-icon"></i>Load Selected Project';
                startCrawlBtn.disabled = false;
                urlInput.disabled = false;
            }
        }

        function transitionToChat(projectName = null) {
            crawlSection.style.display = 'none';
            projectLoadSection.style.display = 'none';
            chatSection.style.display = 'block';
            startChatBtn.classList.remove('pulse'); // In case it was visible
            startChatBtn.style.display = 'none'; // Hide it as we are going to chat directly
            chatSection.scrollIntoView({ behavior: 'smooth' });

            if (projectName) {
                chatSection.dataset.loadedProject = projectName; // Store the loaded project name
            } else {
                delete chatSection.dataset.loadedProject; // Ensure it's clear if no project name (e.g. new crawl)
            }
            connectWebSocket();
        }

        function startCrawling() {
            const url = urlInput.value;
            if (!url) {
                alert("Please enter a valid URL.");
                return;
            }

            startCrawlBtn.disabled = true;
            startCrawlBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin button-icon"></i>Crawling...';
            urlInput.disabled = true;
            startChatBtn.style.display = 'none'; // Hide chat button if re-crawling
            chatSection.style.display = 'none';  // Hide chat section if re-crawling
            updateProgress(0, 'Starting crawl...');

            // Close existing EventSource if any
            if (crawlEventSource) {
                crawlEventSource.close();
            }

            // --- Use EventSource for Progress ---
            crawlEventSource = new EventSource(`/crawl-progress`); // Connect to SSE endpoint

            crawlEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.status === 'progress') {
                    updateProgress(data.percent, data.message);
                } else if (data.status === 'completed') {
                    updateProgress(100, "Crawling and indexing finished!", "completed");
                    startChatBtn.style.display = 'block';
                    startChatBtn.classList.add('pulse');
                    startCrawlBtn.disabled = false;
                    startCrawlBtn.innerHTML = '<i class="fas fa-play button-icon"></i>Start Crawling';
                    urlInput.disabled = false;
                    crawlEventSource.close(); // Close connection on completion
                    loadProjectsList(); // Refresh project list
                } else if (data.status === 'error') {
                    updateProgress(data.percent || 0, `Error: ${data.message}`, "error");
                    startCrawlBtn.disabled = false;
                    startCrawlBtn.innerHTML = '<i class="fas fa-play button-icon"></i>Start Crawling';
                    urlInput.disabled = false;
                    crawlEventSource.close(); // Close connection on error
                    loadProjectsList(); // Refresh project list even on error if appropriate, or not. Decided to refresh.
                }
            };

            crawlEventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                updateProgress(0, "Connection error during crawl progress updates.", "error");
                startCrawlBtn.disabled = false;
                startCrawlBtn.innerHTML = '<i class="fas fa-play button-icon"></i>Start Crawling';
                urlInput.disabled = false;
                if (crawlEventSource) crawlEventSource.close();
                loadProjectsList(); // Refresh project list
            };

             // --- Trigger the crawl process ---
            fetch('/start-crawl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'Crawl started') {
                   updateProgress(0, `Failed to start crawl: ${data.detail || 'Unknown error'}`, "error");
                    startCrawlBtn.disabled = false;
                    startCrawlBtn.innerHTML = '<i class="fas fa-play button-icon"></i>Start Crawling';
                    urlInput.disabled = false;
                     if (crawlEventSource) crawlEventSource.close();
                     loadProjectsList(); // Refresh project list
                } else {
                    console.log("Crawl process initiated by server.");
                     // Progress will be handled by the EventSource
                }
            })
            .catch(error => {
                console.error('Error starting crawl:', error);
                updateProgress(0, `Error starting crawl: ${error}`, "error");
                startCrawlBtn.disabled = false;
                startCrawlBtn.innerHTML = '<i class="fas fa-play button-icon"></i>Start Crawling';
                urlInput.disabled = false;
                 if (crawlEventSource) crawlEventSource.close();
                 loadProjectsList(); // Refresh project list
            });
        }

        function showChat() {
            // This function is now more of a direct transition triggered by "Start Chatting"
            // or by loading a project.
            transitionToChat();
        }

        function renderMarkdown(message) {
            if (!message) return '';

            let displayHtml = message;
            displayHtml = displayHtml.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            displayHtml = displayHtml.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            displayHtml = displayHtml.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            displayHtml = displayHtml.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            displayHtml = displayHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            displayHtml = displayHtml.replace(/\n/g, '<br>');
            displayHtml = displayHtml.replace(/(^|<br>)(?!<(h1|h2|h3|a)>)- /gim, '$1&bull; ');
            return displayHtml;
        }

        function createBotMessageElement() {
            const el = document.createElement('div');
            el.classList.add('message', 'bot-message');
            return el;
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
            if (typingIndicator.parentElement) {
                typingIndicator.parentElement.removeChild(typingIndicator);
            }
        }

        function addMessage(message, type) {
            hideTypingIndicator();

            const messageElement = document.createElement('div');
            messageElement.classList.add('message', type === 'user' ? 'user-message' : 'bot-message');

            if (type === 'user') {
                messageElement.textContent = message;
            } else {
                messageElement.innerHTML = renderMarkdown(message);
            }

            chatOutput.appendChild(messageElement);
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        function showTypingIndicator() {
            if (typingIndicator.parentElement !== chatOutput) {
                chatOutput.appendChild(typingIndicator);
            }
            typingIndicator.style.display = 'flex';
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        function handleSocketMessage(data) {
            if (!data || typeof data !== 'object') {
                addMessage(String(data ?? ''), 'bot');
                return;
            }

            switch (data.type) {
                case 'response_start':
                    hideTypingIndicator();
                    currentBotContent = '';
                    currentBotMessage = createBotMessageElement();
                    chatOutput.appendChild(currentBotMessage);
                    chatOutput.scrollTop = chatOutput.scrollHeight;
                    break;
                case 'response_chunk':
                    if (!currentBotMessage) {
                        currentBotMessage = createBotMessageElement();
                        chatOutput.appendChild(currentBotMessage);
                    }
                    hideTypingIndicator();
                    currentBotContent += data.content || '';
                    currentBotMessage.innerHTML = renderMarkdown(currentBotContent);
                    chatOutput.scrollTop = chatOutput.scrollHeight;
                    break;
                case 'response_end':
                    hideTypingIndicator();
                    currentBotMessage = null;
                    currentBotContent = '';
                    break;
                case 'response_error':
                    hideTypingIndicator();
                    if (currentBotMessage && !currentBotMessage.innerHTML.trim()) {
                        currentBotMessage.remove();
                    }
                    currentBotMessage = null;
                    currentBotContent = '';
                    if (data.message) {
                        addMessage(data.message, 'bot');
                    }
                    break;
                case 'info':
                    hideTypingIndicator();
                    if (data.message) {
                        addMessage(data.message, 'bot');
                    }
                    break;
                default:
                    hideTypingIndicator();
                    addMessage(JSON.stringify(data), 'bot');
            }
        }

        function connectWebSocket() {
            // Ensure only one connection
            if (socket && socket.readyState === WebSocket.OPEN) {
                updateChatStatus('Connected', true);
                return;
            }

            // Use wss:// if served over https, ws:// otherwise
            const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = `${wsProtocol}${window.location.host}/ws/chat`;

            socket = new WebSocket(wsUrl);
            updateChatStatus('Connecting...', false);

            socket.onopen = function(event) {
                console.log("WebSocket connected");
                updateChatStatus('Connected', true);
                sendChatBtn.disabled = false;
                chatInput.disabled = false;
                
                if (chatSection.dataset.loadedProject) {
                     addMessage(`Project '${chatSection.dataset.loadedProject}' loaded. Ask Aera 4B anything about its content!`, "bot");
                     delete chatSection.dataset.loadedProject; // Clear it after displaying
                } else {
                    addMessage("Aera 4B is ready. Ask about the newly crawled content.", "bot");
                }
            };

            socket.onmessage = function(event) {
                console.log("Message from server:", event.data);
                try {
                    const parsed = JSON.parse(event.data);
                    handleSocketMessage(parsed);
                } catch (parseError) {
                    console.warn('Non-JSON message received:', event.data);
                    hideTypingIndicator();
                    addMessage(event.data, "bot");
                }
            };

            socket.onclose = function(event) {
                console.log("WebSocket closed:", event);
                hideTypingIndicator();
                currentBotMessage = null;
                currentBotContent = '';
                updateChatStatus('Disconnected. Refresh or try crawling again.', false, true);
                sendChatBtn.disabled = true;
                chatInput.disabled = true;
                socket = null; // Allow reconnection attempt
            };

            socket.onerror = function(error) {
                console.error("WebSocket error:", error);
                hideTypingIndicator();
                currentBotMessage = null;
                currentBotContent = '';
                updateChatStatus('Connection Error.', false, true);
                sendChatBtn.disabled = true;
                chatInput.disabled = true;
            };
        }

        function updateChatStatus(message, connected = false, error = false) {
            chatStatus.innerHTML = `<div class="status-icon"></div><span>${message}</span>`;
            chatStatus.className = 'chat-status';
            
            if (connected) {
                chatStatus.classList.add('status-connected');
            } else if (error) {
                chatStatus.classList.add('status-error');
            }
        }

        function sendMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addMessage("Not connected to chat.", "bot");
                return;
            }
            const message = chatInput.value;
            if (message.trim() === "") return;

            addMessage(message, "user");
            showTypingIndicator(); // Show typing indicator while waiting for response
            socket.send(message);
            chatInput.value = ""; // Clear input field
        }

        // Allow sending message with Enter key
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initial state
        sendChatBtn.disabled = true;
        chatInput.disabled = true;

        // Wire up buttons
        startCrawlBtn.addEventListener('click', startCrawling);
        startChatBtn.addEventListener('click', showChat);
        sendChatBtn.addEventListener('click', sendMessage);
        loadProjectBtn.addEventListener('click', loadSelectedProject);

        // Load projects when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadProjectsList();
        });
    </script>
</body>
</html>
